## Estructura

```text
vending-app/
├─ pyproject.toml
├─ README.md
└─ vending/
   ├─ __init__.py 
   ├─ main.py          # ← punto de entrada: python -m vending.main
   ├─ exceptions.py
   ├─ models.py
   └─ machine.py
```
---

## `README.md`


# Mini Máquina Expendedora — POO + Excepciones (Python 3.13)

Ejemplo educativo que muestra:
- POO con `Product` y `VendingMachine`
- Excepciones del dominio (inputs inválidos, sin stock, etc.)
- Type hints modernos (3.13)
- Punto de entrada en `vending/main.py`

## Ejecutar
```bash
python -m vending.main
````

> Nota: usa `-m` para que los imports relativos funcionen sin `__init__.py`.


---

## Código fuente

### `vending/exceptions.py`
```python
"""Excepciones del dominio para la máquina expendedora."""

class DomainError(Exception):
    """Base de errores del dominio."""
    pass


class InvalidAmount(DomainError):
    """Montos inválidos (negativos o cero)."""
    pass


class InvalidProduct(DomainError):
    """Datos inválidos para crear un Product (id vacío, precio <= 0)."""
    pass


class ProductNotFound(DomainError):
    """El product_id no existe en el catálogo."""
    pass


class OutOfStock(DomainError):
    """El producto existe pero su stock es 0."""
    pass


class InsufficientFunds(DomainError):
    """El balance es menor que el precio del producto."""
    pass


class DuplicateProduct(DomainError):
    """Se intenta registrar un producto ya existente."""
    pass
````

---

### `vending/models.py`

```python
"""Modelos de dominio: Product."""

from __future__ import annotations

from dataclasses import dataclass
from .exceptions import InvalidProduct


@dataclass(frozen=True)
class Product:
    """Producto vendible (precio en centavos)."""
    id: str
    name: str
    price: int  # > 0

    def __post_init__(self) -> None:
        if not self.id or self.id.strip() == "":
            raise InvalidProduct("El id de producto no puede ser vacío.")
        if self.price <= 0:
            raise InvalidProduct("El precio debe ser un entero positivo (centavos).")
```

---

### `vending/machine.py`

```python
"""Lógica de la máquina expendedora: catálogo, stock, balance y operaciones."""

from __future__ import annotations

from .models import Product
from .exceptions import (
    DomainError,
    InvalidAmount,
    InvalidProduct,
    ProductNotFound,
    OutOfStock,
    InsufficientFunds,
    DuplicateProduct,
)


class VendingMachine:
    """Gestiona catálogo, stock, balance y operaciones."""

    def __init__(self) -> None:
        self._catalog: dict[str, Product] = {}
        self._stock: dict[str, int] = {}
        self._balance: int = 0  # centavos

    # -------- Helpers internos --------

    def _ensure_exists(self, product_id: str) -> Product:
        product = self._catalog.get(product_id)
        if product is None:
            raise ProductNotFound(f"Producto '{product_id}' no existe.")
        return product

    def _assert_invariants(self) -> None:
        assert self._balance >= 0, "Invariant: balance >= 0"
        for pid, qty in self._stock.items():
            assert qty >= 0, f"Invariant: stock[{pid}] >= 0"
            assert pid in self._catalog, f"Invariant: {pid} debe existir en catálogo"

    # -------- API pública --------

    def add_product(self, product: Product, stock: int) -> None:
        """Registra un producto y define su stock inicial."""
        if stock < 0:
            raise InvalidAmount("El stock inicial debe ser >= 0.")
        if product.id in self._catalog:
            raise DuplicateProduct(f"El producto '{product.id}' ya existe.")

        self._catalog[product.id] = product
        self._stock[product.id] = stock
        self._assert_invariants()

    def insert(self, amount: int) -> None:
        """Inserta dinero en centavos (> 0)."""
        if amount <= 0:
            raise InvalidAmount("El monto insertado debe ser > 0.")
        self._balance += amount
        self._assert_invariants()

    def get_stock(self, product_id: str) -> int:
        """Devuelve el stock actual del producto (>= 0)."""
        self._ensure_exists(product_id)
        return self._stock[product_id]

    def get_price(self, product_id: str) -> int:
        """Devuelve el precio en centavos (> 0)."""
        product = self._ensure_exists(product_id)
        return product.price

    def buy(self, product_id: str) -> int:
        """
        Compra 1 unidad del producto:
          1) Existe -> ProductNotFound
          2) stock > 0 -> OutOfStock
          3) balance >= price -> InsufficientFunds
          4) Efectos: stock -= 1, balance -= price, change = balance, balance = 0
          5) Retorna 'change' (centavos)
        """
        product = self._ensure_exists(product_id)

        if self._stock[product_id] == 0:
            raise OutOfStock(f"No hay stock para '{product_id}'.")

        price: int = product.price
        if self._balance < price:
            raise InsufficientFunds(
                f"Fondos insuficientes: balance={self._balance}, price={price}"
            )

        self._stock[product_id] -= 1
        self._balance -= price
        change: int = self._balance
        self._balance = 0

        self._assert_invariants()
        return change

    def cancel(self) -> int:
        """Devuelve todo el balance y lo reinicia a 0."""
        amount: int = self._balance
        self._balance = 0
        self._assert_invariants()
        return amount

    # -------- Inspección --------

    def balance(self) -> int:
        """Balance actual (solo lectura)."""
        return self._balance

    def __repr__(self) -> str:
        return f"VendingMachine(balance={self._balance}, stock={self._stock})"
```

---

### `vending/main.py`

```python
"""Punto de entrada. Ejecuta:  python -m vending.main"""

from __future__ import annotations

from .models import Product
from .machine import VendingMachine


def main() -> None:
    vm: VendingMachine = VendingMachine()

    # Registrar productos
    vm.add_product(Product("A1", "Agua", 800), stock=2)
    vm.add_product(Product("B2", "Barra energética", 1200), stock=1)

    # Flujo 1: compra válida
    vm.insert(1_000)
    change = vm.buy("A1")
    print("Compra A1 → cambio:", change)          # 200
    print("Stock A1:", vm.get_stock("A1"))        # 1
    print("Balance tras compra:", vm.balance())     # 0

    # Flujo 2: cancelar
    vm.insert(500)
    refunded = vm.cancel()
    print("Cancelar → devuelve:", refunded)       # 500
    print("Balance tras cancelar:", vm.balance())   # 0


if __name__ == "__main__":
    main()
```

---

## ▶️ Cómo ejecutar

```bash
# desde la carpeta vending-app/
python -m vending.main
```
